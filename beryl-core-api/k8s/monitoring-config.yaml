apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: beryl-monitoring
  labels:
    app: prometheus
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    rule_files:
      - /etc/prometheus/prometheus.rules

    alerting:
      alertmanagers:
      - static_configs:
        - targets:
          - alertmanager.beryl-monitoring.svc.cluster.local:9093

    scrape_configs:
    - job_name: 'beryl-core-api'
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
          - default
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_label_app]
        regex: beryl-core-api
        action: keep
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        regex: "true"
        action: keep
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        target_label: __metrics_path__
        regex: (.+)
        replacement: ${1}
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_port]
        target_label: __address__
        regex: (.+)
        replacement: ${1}

    - job_name: 'graphql-gateway'
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
          - default
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_label_app]
        regex: graphql-gateway
        action: keep
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        regex: "true"
        action: keep

    - job_name: 'event-bus'
      static_configs:
      - targets: ['event-bus.default.svc.cluster.local:9308']
        labels:
          service: kafka

    - job_name: 'kubernetes-apiserver'
      kubernetes_sd_configs:
      - role: endpoints
        namespaces:
          names:
          - default
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
        action: keep
        regex: default;kubernetes;https

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: default
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush         5
        Log_Level     info
        Daemon        off

    [INPUT]
        Name              tail
        Path              /var/log/beryl/audit.log
        Parser            json
        Tag               audit.*
        Refresh_Interval  5

    [INPUT]
        Name              tail
        Path              /app/logs/*.log
        Parser            json
        Tag               app.*
        Refresh_Interval  5

    [OUTPUT]
        Name  es
        Match audit.*
        Host  elasticsearch.beryl-monitoring.svc.cluster.local
        Port  9200
        Index audit-{strftime:%Y.%m.%d}
        Type  audit

    [OUTPUT]
        Name  es
        Match app.*
        Host  elasticsearch.beryl-monitoring.svc.cluster.local
        Port  9200
        Index app-{strftime:%Y.%m.%d}
        Type  app

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: jaeger-config
  namespace: beryl-monitoring
data:
  jaeger.yml: |
    service:
      extensions: [jaeger_storage, jaeger_query]
      pipelines:
        traces:
          receivers: [otlp]
          processors: [batch]
          exporters: [jaeger_storage]
        metrics:
          receivers: [otlp]
          processors: [batch]
          exporters: [logging]

    extensions:
      jaeger_storage:
        backends:
          memory:
            max_traces: 100000
      jaeger_query:
        storage:
          traces: memory

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

    processors:
      batch:
        timeout: 1s
        send_batch_size: 1024

    exporters:
      logging:
        loglevel: debug