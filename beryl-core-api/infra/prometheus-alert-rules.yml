groups:
  - name: beryl-regulatory-hardening
    rules:
      - alert: KafkaConsumerLagCritical
        expr: max by (group) (kafka_consumer_lag) > 1000
        for: 2m
        labels:
          severity: critical
          service: beryl-core-api
        annotations:
          summary: Kafka consumer lag critical
          description: Kafka consumer lag is above threshold for sustained period.

      - alert: DLQEventCritical
        expr: increase(dlq_events_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          service: beryl-core-api
        annotations:
          summary: DLQ event critical
          description: DLQ received events in the last 5 minutes.

      - alert: AuditIntegrityFailure
        expr: increase(audit_integrity_failures_total[5m]) > 0
        for: 30s
        labels:
          severity: critical
          service: beryl-core-api
        annotations:
          summary: Audit integrity failure
          description: Immutable audit chain verification failed.

      - alert: SignatureFailureAnomaly
        expr: increase(signature_validation_failures_total[5m]) > 5
        for: 1m
        labels:
          severity: critical
          service: beryl-core-api
        annotations:
          summary: Signature validation failure anomaly
          description: Signature validation failures exceed accepted rate.

      - alert: AMLSpikeAnomaly
        expr: increase(aml_flagged_total[10m]) > 25
        for: 2m
        labels:
          severity: critical
          service: beryl-core-api
        annotations:
          summary: AML flagged spike
          description: AML flagged transactions spiked above threshold.

      - alert: PSPReplayDetectionAnomaly
        expr: increase(security_incident_total{reason=~"replay|nonce_reuse|duplicate_psp_notification"}[10m]) > 0
        for: 30s
        labels:
          severity: critical
          service: beryl-core-api
        annotations:
          summary: PSP replay detection anomaly
          description: Replay-related security incidents detected.
